{{ define "main" }}
<article class="single-post h-entry outlined-card">
  
  <div style="display: none;" class="p-author h-card">
    <a href="{{ .Site.BaseURL }}" class="u-url p-name">{{ .Site.Params.author.name }}</a>
    <img src="{{ .Site.Params.author.photo | absURL }}" class="u-photo" alt="{{ .Site.Params.author.name }}">
  </div>

  <header class="post-header">
    <div class="headline-row">
      {{ partial "ui/chip.html" . }}
      <h1 class="p-name">{{ .Title }}</h1>
    </div>
    
    <div class="post-meta">
      <div class="meta-item">
        <span class="meta-icon">{{ partial "icons/event.svg" . }}</span>
        <div class="meta-text">
          <time class="dt-published" datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">
            {{ .Date.Format "Monday, Jan 2, 2006 at 3:04 PM (MST)" }}
          </time>
          {{ if ne .Date .Lastmod }}
          <span class="dt-updated-label">
            (Updated: <time class="dt-updated" datetime="{{ .Lastmod.Format "2006-01-02T15:04:05Z07:00" }}">{{ .Lastmod.Format "Jan 2, 2006" }}</time>)
          </span>
          {{ end }}
        </div>
      </div>

      <div class="meta-item">
        <span class="meta-icon">{{ partial "icons/schedule.svg" . }}</span>
        <span class="reading-time">{{ .ReadingTime }} min read</span>
      </div>
    </div>
  </header>

  {{/* NEW: MD3 Tonal Context Blocks */}}
  <div class="context-container">
    {{ if .Params.reply_to }}
    <div class="context-block reply-context">
      <span class="context-icon">{{ partial "icons/replies.svg" . }}</span>
      <span class="context-label">Replying to</span>
      <a href="{{ .Params.reply_to }}" class="u-in-reply-to context-link">{{ .Params.reply_to | truncate 50 }}</a>
    </div>
    {{ end }}

    {{ if .Params.like_of }}
    <div class="context-block like-context">
      <span class="context-icon">{{ partial "icons/likes.svg" . }}</span>
      <span class="context-label">Liked</span>
      <a href="{{ .Params.like_of }}" class="u-like-of context-link">{{ .Params.like_of | truncate 50 }}</a>
    </div>
    {{ end }}

    {{ if .Params.repost_of }}
    <div class="context-block repost-context">
      <span class="context-icon">{{ partial "icons/reposts.svg" . }}</span>
      <span class="context-label">Reposted</span>
      <a href="{{ .Params.repost_of }}" class="u-repost-of context-link">{{ .Params.repost_of | truncate 50 }}</a>
    </div>
    {{ end }}

    {{ if .Params.bookmark_of }}
    <div class="context-block bookmark-context">
      <span class="context-icon">{{ partial "icons/bookmarks.svg" . }}</span>
      <span class="context-label">Bookmarked</span>
      <a href="{{ .Params.bookmark_of }}" class="u-bookmark-of context-link">{{ .Params.bookmark_of | truncate 50 }}</a>
    </div>
    {{ end }}

    {{ if and .Params.rsvp .Params.reply_to }}
    <div class="context-block rsvp-context">
      <span class="context-icon">{{ partial "icons/rsvps.svg" . }}</span>
      <span class="context-label">RSVP: <strong class="p-rsvp">{{ .Params.rsvp | upper }}</strong> to</span>
      <a href="{{ .Params.reply_to }}" class="u-in-reply-to context-link">{{ .Params.reply_to | truncate 40 }}</a>
    </div>
    {{ end }}
  </div>

  <div class="e-content">{{ .Content }}</div>

  <footer class="post-footer">
    {{ if .Params.syndication }}
    <div class="syndication-container">
      <span class="syndication-label">Also on:</span>
      <div class="syndication-chips" style="display: inline-flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
        {{ range .Params.syndication }}
          {{ $synURL := . }}
          {{ $match := false }}
          {{ $data := dict }}
          {{ range $.Site.Params.social }}
             {{ if in $synURL .url }}
               {{ $match = true }}
               {{ $data = . }}
             {{ end }}
          {{ end }}
          <a href="{{ $synURL }}" class="chip u-syndication" rel="syndication" style="text-decoration: none;">
            {{ if $match }}
               {{ if $data.icon }}<span class="chip-icon" aria-hidden="true" style="color: var(--md-sys-color-primary);">{{ partial (printf "icons/%s.svg" $data.icon) . }}</span>{{ end }}
               <span class="chip-label">{{ $data.name }}</span>
            {{ else }}
               <span class="chip-label">{{ replaceRE "^https?://([^/]+).*" "$1" $synURL }}</span>
            {{ end }}
          </a>
        {{ end }}
      </div>
    </div>
    {{ end }}

    {{ if .Params.tags }}
    <ul class="tags">{{ range .Params.tags }}<li><a href="{{ "/tags/" | relLangURL }}{{ . | urlize }}" class="p-category">#{{ . }}</a></li>{{ end }}</ul>
    {{ end }}
  </footer>
</article>

{{ partial "share-buttons.html" . }}

{{/* UNIVERSAL WEBMENTIONS LOGIC */}}
{{ $show := .Params.show_webmentions }}
{{ if eq $show nil }}
  {{ $show = .Site.Params.webmentions.show_webmentions }}
{{ end }}

{{ if $show }}
  {{ partial "webmentions-card.html" (dict 
      "context" .
      "description" "Have your say. Write a post on your own site and link to this URL to appear here!"
  ) }}
{{ end }}
{{ end }}
