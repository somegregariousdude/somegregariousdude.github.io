{{ $host := .Get "host" }}
{{ $id := .Get "id" }}

{{ if and $host $id }}
  {{ $apiURL := printf "https://%s/api/v1/statuses/%s" $host $id }}
  
  {{/* Fetch Data */}}
  {{ $data := dict }}
  {{ $response := resources.GetRemote $apiURL }}
  
  {{ if $response }}
    {{ if eq $response.StatusCode 200 }}
      {{ $data = $response.Content | transform.Unmarshal }}
    {{ else }}
      <div class="mastodon-card error outlined-card">
        <p><strong>Error:</strong> Could not fetch Mastodon post (Status {{ $response.StatusCode }}).</p>
        <p><a href="https://{{ $host }}/@{{ $id }}">View Original on {{ $host }}</a></p>
      </div>
    {{ end }}
  {{ else }}
    <div class="mastodon-card error outlined-card">
      <p><strong>Error:</strong> Unable to reach Mastodon instance ({{ $host }}).</p>
    </div>
  {{ end }}

  {{ if $data }}
    <article class="mastodon-card outlined-card" lang="{{ $data.language | default "en" }}">
      
      {{/* HEADER */}}
      <header class="mastodon-header">
        <div class="mastodon-author">
          {{ $avatar := resources.GetRemote $data.account.avatar }}
          {{ if $avatar }}
             {{ if $avatar.Err }}
               <div class="u-photo-placeholder">?</div>
             {{ else }}
               <img src="{{ $avatar.RelPermalink }}" alt="" class="u-photo" width="48" height="48" loading="lazy">
             {{ end }}
          {{ else }}
             <div class="u-photo-placeholder">?</div>
          {{ end }}
          
          <div class="author-meta">
            <a href="{{ $data.account.url }}" class="p-name u-url" target="_blank" rel="noopener noreferrer">
              <strong>{{ $data.account.display_name | default $data.account.username }}</strong>
            </a>
            <span class="p-nickname">@{{ $data.account.username }}@{{ $host }}</span>
          </div>
        </div>
        
        <div class="mastodon-logo" aria-label="Mastodon Post">
          {{ partial "icons/mastodon.svg" . }}
        </div>
      </header>

      {{/* BODY */}}
      <div class="e-content">
        {{ $data.content | safeHTML }}
      </div>

      {{/* MEDIA: Handles Images AND Videos now */}}
      {{ if $data.media_attachments }}
      <div class="mastodon-media">
        {{ range $data.media_attachments }}
          {{/* LOGIC: Determine Source & Type */}}
          {{ $src := "" }}
          {{ $isVideo := false }}
          
          {{ if eq .type "image" }}
             {{ $src = .url }}
          {{ else if or (eq .type "video") (eq .type "gifv") }}
             {{ $src = .preview_url }} {{/* Use thumbnail for static site */}}
             {{ $isVideo = true }}
          {{ end }}

          {{ if $src }}
            {{ $imgRes := resources.GetRemote $src }}
            {{ if $imgRes }}
              {{ if not $imgRes.Err }}
                <div class="media-item">
                  {{/* VISUAL: u-photo (Preview) */}}
                  <img src="{{ $imgRes.RelPermalink }}" class="u-photo" alt="{{ .description | default "Media attachment" }}" loading="lazy">
                  
                  {{/* DATA: u-video (Hidden Link to original file) */}}
                  {{ if $isVideo }}
                    <a href="{{ .url }}" class="u-video" style="display:none;" aria-hidden="true">Watch Video</a>
                    {{/* Optional: Overlay icon to indicate video */}}
                    <div class="play-overlay" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;">
                       <span style="background:rgba(0,0,0,0.5); color:white; padding:8px; border-radius:50%;">▶</span>
                    </div>
                  {{ end }}
                </div>
              {{ end }}
            {{ end }}
          {{ end }}
        {{ end }}
      </div>
      {{ end }}

      {{/* FOOTER */}}
      <footer class="mastodon-footer">
        <time class="dt-published" datetime="{{ $data.created_at }}">
          {{ dateFormat "Jan 02, 2006" $data.created_at }}
        </time>
        <div class="mastodon-stats">
          <span>↩ {{ $data.replies_count }}</span>
          <span>↻ {{ $data.reblogs_count }}</span>
          <span>♥ {{ $data.favourites_count }}</span>
        </div>
        <a href="{{ $data.url }}" class="button-small" target="_blank" rel="noopener noreferrer">View Original</a>
      </footer>
    </article>
  {{ end }}

{{ else }}
  <p class="error"><strong>Mastodon Shortcode Error:</strong> Missing 'host' or 'id' parameter.</p>
{{ end }}
